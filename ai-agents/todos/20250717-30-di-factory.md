# Task 30: DIコンテナのFactory化とAdapter直接依存の解消

## 概要
DIコンテナ（containers.py）がAdapter実装を直接参照している問題を、Factoryパターンを使用して解消する。

## 背景
Task27でDetectorFactoryを使用してHeuristicMainContentDetectorの直接参照を解消した。同様のパターンを他のAdapterにも適用し、クリーンアーキテクチャの依存関係ルールを遵守する。

## 問題点
containers.pyが以下のAdapter実装を直接インポート・参照している：
- FileRepository
- WgetCrawler
- BeautifulSoupParser, BeautifulSoupAnalyzer, LLMPreprocessor
- ChardetDetector

これはCore層がAdapter層に依存することになり、Dependency Inversion Principleに違反。

## 修正内容

### 1. Repository Factoryの作成
`src/site2/adapters/storage/repository_factory.py`:
```python
from typing import Dict, Any
from pathlib import Path
from ...core.ports.fetch_contracts import WebsiteCacheRepositoryProtocol
from .file_repository import FileRepository

class RepositoryFactory:
    """リポジトリのファクトリークラス"""

    @staticmethod
    def create(
        method: str = "file",
        **kwargs
    ) -> WebsiteCacheRepositoryProtocol:
        """リポジトリを作成"""
        if method == "file":
            return FileRepository(**kwargs)
        else:
            raise ValueError(f"Unknown repository method: {method}")
```

### 2. Crawler Factoryの作成
`src/site2/adapters/crawlers/crawler_factory.py`:
```python
from typing import Dict, Any
from ...core.ports.fetch_contracts import WebCrawlerProtocol
from .wget_crawler import WgetCrawler

class CrawlerFactory:
    """クローラーのファクトリークラス"""

    @staticmethod
    def create(
        method: str = "wget",
        **kwargs
    ) -> WebCrawlerProtocol:
        """クローラーを作成"""
        if method == "wget":
            return WgetCrawler(**kwargs)
        else:
            raise ValueError(f"Unknown crawler method: {method}")
```

### 3. Parser Factoryの作成
`src/site2/adapters/parsers/parser_factory.py`:
```python
from typing import Dict, Any, Union
from ...core.ports.parser_contracts import (
    HTMLParserProtocol,
    HTMLAnalyzerProtocol,
    HTMLPreprocessorProtocol,
    EncodingDetectorProtocol
)
from .beautifulsoup_parser import (
    BeautifulSoupParser,
    BeautifulSoupAnalyzer,
    LLMPreprocessor
)
from .chardet_detector import ChardetDetector

class ParserFactory:
    """パーサー関連のファクトリークラス"""

    @staticmethod
    def create_parser(
        method: str = "beautifulsoup",
        **kwargs
    ) -> HTMLParserProtocol:
        """HTMLパーサーを作成"""
        if method == "beautifulsoup":
            return BeautifulSoupParser(**kwargs)
        else:
            raise ValueError(f"Unknown parser method: {method}")

    @staticmethod
    def create_analyzer(
        method: str = "beautifulsoup",
        **kwargs
    ) -> HTMLAnalyzerProtocol:
        """HTMLアナライザーを作成"""
        if method == "beautifulsoup":
            return BeautifulSoupAnalyzer(**kwargs)
        else:
            raise ValueError(f"Unknown analyzer method: {method}")

    @staticmethod
    def create_preprocessor(
        method: str = "llm",
        **kwargs
    ) -> HTMLPreprocessorProtocol:
        """HTMLプリプロセッサーを作成"""
        if method == "llm":
            return LLMPreprocessor(**kwargs)
        else:
            raise ValueError(f"Unknown preprocessor method: {method}")

    @staticmethod
    def create_encoding_detector(
        method: str = "chardet",
        **kwargs
    ) -> EncodingDetectorProtocol:
        """エンコーディング検出器を作成"""
        if method == "chardet":
            return ChardetDetector(**kwargs)
        else:
            raise ValueError(f"Unknown detector method: {method}")
```

### 4. containers.pyの修正
```python
# 直接インポートを削除
# from ..adapters.storage.file_repository import FileRepository
# from ..adapters.crawlers.wget_crawler import WgetCrawler
# from ..adapters.parsers.beautifulsoup_parser import ...
# from ..adapters.parsers.chardet_detector import ChardetDetector

# Factoryインポートに変更
from ..adapters.storage.repository_factory import RepositoryFactory
from ..adapters.crawlers.crawler_factory import CrawlerFactory
from ..adapters.parsers.parser_factory import ParserFactory
from ..adapters.detectors.detector_factory import DetectorFactory

# プロバイダーをFactory経由に変更
website_cache_repository = providers.Factory(
    RepositoryFactory.create,
    method="file",
    cache_dir=settings.provided.cache_dir,
)

web_crawler = providers.Factory(
    CrawlerFactory.create,
    method="wget",
    timeout=settings.provided.wget_timeout,
    user_agent=settings.provided.user_agent,
    delay=settings.provided.crawl_delay,
)

encoding_detector = providers.Factory(
    ParserFactory.create_encoding_detector,
    method="chardet",
)

html_parser = providers.Factory(
    ParserFactory.create_parser,
    method="beautifulsoup",
)

html_analyzer = providers.Factory(
    ParserFactory.create_analyzer,
    method="beautifulsoup",
)

llm_preprocessor = providers.Factory(
    ParserFactory.create_preprocessor,
    method="llm",
)
```

## 期待される効果
- **依存関係の逆転**: Core層がAdapter層の抽象に依存
- **拡張性の向上**: 新しい実装の追加が容易
- **テスタビリティ**: モック実装への切り替えが簡単
- **設定可能性**: 実装メソッドを設定で切り替え可能

## 実装手順
1. 各Factoryクラスを作成
2. containers.pyから直接インポートを削除
3. Factoryインポートに変更
4. プロバイダー定義をFactory経由に修正
5. テスト実行で動作確認
6. 設定での切り替えをテスト

## 関連ファイル
- src/site2/adapters/storage/repository_factory.py (新規)
- src/site2/adapters/crawlers/crawler_factory.py (新規)
- src/site2/adapters/parsers/parser_factory.py (新規)
- src/site2/core/containers.py (修正)

## 完了条件
- [ ] すべてのFactoryクラスが作成されている
- [ ] containers.pyにAdapter実装の直接インポートがない
- [ ] すべてのプロバイダーがFactory経由で作成されている
- [ ] 既存のテストがすべて通過する
- [ ] DIコンテナの初期化が正常に動作する
