# 統合テストで発見された問題点

## インターフェースの不整合

### ✅ 解決済み
- [x] ドメインモデルの不足: `MainContent`, `Navigation`, `MarkdownDocument`が未実装
- [x] モジュール名の不一致: `site2.core.domain.fetch`ではなく`site2.core.domain.fetch_domain`
- [x] Protocol命名規則: `IFetchService`など`I`プレフィックスが期待されるが、実際は`FetchServiceProtocol`

### 🔄 要検討
- [ ] FetchResultの構造: 実際の`FetchResult`にHTMLコンテンツが直接含まれていない
- [ ] Protocol定義と実装の不一致: モックサービスで動的属性追加が必要
- [ ] 非同期/同期の混在: 全てのサービスメソッドが`async`だが、一部は同期でも良い可能性

## データフローの問題

### ✅ 解決済み
- [x] HttpUrl正規化: `http://test-site`が`http://test-site/`に正規化される
- [x] CachedPageの構造: フィールド名が期待と異なる（`file_path`→`local_path`など）

### 🔄 要検討
- [ ] サービス間のデータ受け渡し: FetchResult→DetectService間でHTMLコンテンツの受け渡し方法
- [ ] エラーハンドリングの不足: 各サービスでの例外処理パターンが未統一
- [ ] ドメインモデルの責務: CachedPageとFetchResultの関係が不明確

## DI（依存性注入）の問題

### ✅ 解決済み
- [x] pytest-asyncioの設定: `pytest.ini`に設定追加が必要
- [x] TestContainerのオーバーライド: モックサービスの正しい注入方法を確立

### 🔄 要検討
- [ ] プレースホルダーサービス: 現在の`"placeholder"`文字列は型安全でない
- [ ] ライフサイクル管理: シングルトンとファクトリーの使い分けが未整理
- [ ] テスト分離: 各テストでコンテナが完全に分離されているか確認が必要

## アーキテクチャ設計の課題

### 🔄 要検討
- [ ] 契約ファーストの徹底: Protocol定義が実装に先行していない箇所がある
- [ ] ドメインモデルの完成度: 一部のエンティティで必要なメソッドが不足
- [ ] レイヤー分離: ドメイン層とアプリケーション層の境界が曖昧

## 今後のアクション

### 短期的（Task 3で対応）
1. **Protocol命名規則の統一**: `I`プレフィックス付きに統一
2. **FetchResultの設計見直し**: HTMLコンテンツの適切な含め方
3. **エラーハンドリングの標準化**: 各サービスでの例外処理パターン統一

### 中期的（実装フェーズで対応）
1. **実際のサービス実装**: モックから実サービスへの移行
2. **型安全性の向上**: プレースホルダーの型安全な実装
3. **パフォーマンス最適化**: 非同期処理の適切な活用

### 長期的（運用フェーズで対応）
1. **監視・ログ機能**: パイプライン全体の実行状況監視
2. **拡張性の確保**: 新しいサービスの追加に対する柔軟性
3. **テストカバレッジ**: エッジケースと異常系のテスト充実

## 技術的な知見

### うまくいったこと
- **dependency-injector**: DIコンテナが期待通りに動作
- **Pydantic**: ドメインモデルの型安全性が保たれている
- **pytest-asyncio**: 非同期テストが正常に実行できる
- **モックファースト**: 実装前にインターフェースの問題を発見できた

### 改善が必要なこと
- **Contract-First設計**: Protocol定義を先に完成させる必要
- **ドメインモデルの事前設計**: 不足しているエンティティの早期発見
- **テストデータの管理**: フィクスチャの整備と管理方法
- **エラーシナリオ**: 正常系だけでなく異常系のテストも重要

## 次のステップへの提言

Task 3（詳細設計）では以下に重点を置くことを推奨：

1. **インターフェース設計の完成**: 全てのProtocolの定義を最初に行う
2. **データフロー設計**: サービス間のデータ受け渡しの標準化
3. **エラーハンドリング設計**: 統一された例外処理パターンの策定
4. **テスト戦略**: 統合テストから単体テストまでの包括的なテスト計画

これらの知見により、より堅牢で保守性の高いアーキテクチャを構築できると考えられます。
