[TOC](/docs/TOC.md)

## トランクベース開発 (Trunk-Based Development) ガイド

このドキュメントは、私たちのチームが採用するソースコード管理のスタイルである**トランクベース開発 (TBD)** について、その目的、日々の開発フロー、そしてリリース戦略までを網羅した実践的なガイドです。

### 1\. トランクベース開発とは何か？

**トランクベース開発**は、すべての開発者が\*\*単一の共通ブランチ（`main`）\*\*に対して、非常に短いサイクルの変更を頻繁に統合していく開発スタイルです。

長期間のフィーチャーブランチは作らず、全員が常に最新のトランクをベースに作業することで、「マージ地獄」を避け、継続的インテグレーション(CI)を最大化します。

#### 🎯 目的と前提

  * **目的**: コードの統合コストを最小化し、開発のリードタイムを短縮すること。
  * **前提**: このスタイルを安全に実践するには、以下のプラクティスが不可欠です。
      * **堅牢な自動テスト**: トランクが常に正常な状態であることを保証します。
      * **フィーチャートグル**: 未完成の機能をOFFの状態でマージし、本番環境に影響を与えないようにします。

-----

### 2\. 日々の開発フロー：タスク開始から完了まで

**シナリオ**: 開発者Aさんが、「ユーザー一覧画面にCSVエクスポート機能を追加する」タスクを担当します。

#### Step 1: ローカルでの作業開始

まず、ローカルの`main`ブランチを最新の状態にし、そこからごく短期間だけ使用するタスクブランチを作成します。

```bash
# 1. mainブランチに切り替え
git checkout main

# 2. リモートの最新状態を取得
git pull origin main

# 3. 短命なブランチを作成（寿命は数時間〜1日程度）
git checkout -b feature/add-csv-export
```

#### Step 2: 実装とコミット

機能を小さなステップに分割し、頻繁にコミットします。作業中も、他の人の変更を頻繁に自分のブランチに取り込み、差分が大きくならないようにします。

```bash
# (コードを実装...)
git add .
git commit -m "feat: ユーザー一覧画面にCSVエクスポートボタンを追加 (feature-toggle: off)"

# (他の人の変更を取り込む)
git pull origin main

# (さらに実装とコミットを続ける...)
```

#### Step 3: プルリクエスト (PR) の作成とマージ

作業が完了したら、リモートにブランチをプッシュし、プルリクエスト（PR）を作成します。

```bash
# リモートにブランチをプッシュ
git push origin feature/add-csv-export
```

PRは小さく、レビューが短時間で完了するように心がけます。CIの自動テストがパスし、レビューで承認されたら、即座に`main`ブランチにマージします。

#### Step 4: ブランチの整理（クリーンアップ）

PRが`main`にマージされたら、そのブランチの役目は終わりです。リポジトリを綺麗に保つため、**ローカルとリモートの両方からブランチを削除します**。

```bash
# 1. ローカルのmainブランチに切り替え
git checkout main

# 2. ローカルの作業ブランチを削除
git branch -d feature/add-csv-export

# 3. リモート(origin)のブランチを削除
git push origin --delete feature/add-csv-export
```

-----

### 3\. リリース戦略：安定したバージョンを届ける

TBDでは、**「マージ（統合）」と「リリース（公開）」は明確に分離**されます。`main`ブランチは常にデプロイ可能な状態ですが、必ずしも最新のコミットが本番にリリースされるわけではありません。

#### Step 1: リリースポイントの決定とリリースブランチの作成

リリースする準備が整ったら、`main`ブランチの**特定の安定したコミット**から、`release/v1.2.0`のようなリリース専用のブランチを作成します。

```bash
# mainブランチの特定のコミットIDからリリースブランチを作成
git checkout -b release/v1.2.0 <commit-id>
```

このブランチは、そのバージョンのための「凍結された」安定版となり、これ以降、新しい機能が追加されることはありません。

#### Step 2: リリースとバージョンのタグ付け

CI/CDパイプラインは、この**リリースブランチ**を対象にビルドとデプロイを行います。デプロイが成功したら、そのコミットにバージョンタグを付けます。

```bash
# リリースブランチに切り替え
git checkout release/v1.2.0

# バージョンタグを付ける
git tag v1.2.0

# リリースブランチとタグをリモートにプッシュ
git push origin release/v1.2.0
git push origin v1.2.0
```

#### Step 3: ホットフィックス（緊急のバグ修正）

もしリリースした`v1.2.0`に緊急のバグが見つかった場合、以下の手順で対応します。

1.  修正はまず`main`ブランチで行います。
2.  その修正コミットを、`release/v1.2.0`ブランチに**チェリーピック**（特定のコミットだけを取り込む）します。
3.  修正が適用された`release/v1.2.0`ブランチに、新しいバージョンタグ（例: `v1.2.1`）を付けて、再度リリースします。

### まとめ

トランクベース開発は、頻繁な統合によってチーム全体の開発スピードとコードの安定性を両立させるための、現代的で効果的な開発スタイルです。このフローをチームで実践し、迅速かつ安全な開発サイクルを確立していきましょう。