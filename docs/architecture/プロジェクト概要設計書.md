[ToC](/docs/TOC.md)

# プロジェクト概要設計書

## プロジェクトの目的と背景

### 目的
`site2`は、指定されたWebサイトのコンテンツを取得し、1つのMarkdownファイルまたはPDFファイルに統合するCLIツールです。ドキュメントサイトやマニュアルサイトなどの構造化されたWebコンテンツを、オフラインで参照可能な単一ファイルとして保存することを目的としています。

### 背景
前身プロジェクト`site2pdf`の開発を通じて、以下の課題が明らかになりました：

1. **出力形式の制限**: PDF出力のみで、より汎用的なMarkdown形式への対応が必要
2. **開発プロセスの複雑化**: AI agentによる自律的開発により、成果物の把握が困難に
3. **品質管理の困難さ**: 余計なHTMLタグの残存、ページ順序の誤りなど

これらの課題を解決し、より制御可能で品質の高いツールを開発するため、`site2`プロジェクトを立ち上げました。

## 主要機能の概要

> [!Usage:]
>
>   site2 [--format <md|pdf>] <uri>
>       指定された uri からファイルを取得して1枚のファイルにまとめて標準出力に出力する
>       リカーシブに動作します
>   
>   site2 fetch <uri>
>       指定された uri からファイルを取得してキャッシュする  
>       キャッシュが存在するときは更新されたファイルだけを更新する
>       リカーシブに動作します
>   
>   site2 fetch list
>       既に fetch 済みのキャッシュを一覧表示する
>   
>   site2 detect main <file_or_uri>
>       ドキュメントのメインの文章ブロックへの CSS セレクタを返す
>   
>   site2 detect nav <file_or_uri>
>       ドキュメントのナビゲーションブロックへの CSS セレクタを返す
>   
>   site2 detect order <path_or_uri>
>       ドキュメントの一覧を出力順に標準出力に出力します
>   
>   site2 build [--format <md|pdf>] <file_or_uri>...
>       指定されたファイルまたは uri を指定されたフォーマットに変換し、指定された順番にマージして標準出力に出力する

## 技術スタックの選定理由

### 言語: Python
- **実績**: 前プロジェクトで安定動作を確認
- **エコシステム**: Web スクレイピング、PDF生成、Markdown処理の優れたライブラリが豊富
- **保守性**: 読みやすく、AIとの協調開発に適している

### 主要ライブラリ
- **Rye**: モダンなPythonプロジェクト管理ツール。依存関係管理が容易
- **Typer**: 直感的なCLI構築。型ヒントベースで保守性が高い
- **wget (外部コマンド)**: 
  - 堅牢なWebサイト取得機能
  - SSL問題の自動解決
  - 優秀なキャッシュ機能
  - 更新日を考慮した差分取得
- **BeautifulSoup4**: HTML解析の定番。安定性が高い
- **Playwright**: ブラウザベースのレンダリング。JavaScriptで生成されるコンテンツにも対応
- **pypdf**: PDF操作ライブラリ

### 新規追加予定
- **Markdown処理ライブラリ**: MarkdownファイルのパースとHTML変換
- **Jinja2等のテンプレートエンジン**: 出力フォーマットの柔軟な制御

## 前プロジェクトからの改善点

### 1. 出力形式の拡張
- **Markdown出力をデフォルトに**: より汎用的で編集可能な形式
- **PDF出力も継続サポート**: 印刷や配布に適した形式として

### 2. アーキテクチャの改善
- **モジュール分離の明確化**: 各機能の責務を明確に定義
- **インターフェースの標準化**: モジュール間の連携を疎結合に

### 3. 品質向上施策
- **不要タグの確実な除去**: Parser機能の強化
- **ページ順序の正確性向上**: ナビゲーション構造の解析精度向上
- **テスト駆動開発**: 各モジュールに対する単体テスト・統合テストの充実

### 4. 開発プロセスの改善
- **設計先行アプローチ**: AIによる実装前に、人間による設計を完了
- **段階的な実装**: モックアップ→テスト→実装の順序で進行
- **AI活用の制御**: 各AIエージェントの役割を明確に定義し、暴走を防止

### 5. ユーザビリティの向上
- **標準出力への出力**: パイプラインでの利用を容易に
- **検出機能の追加**: メインコンテンツやナビゲーションの自動検出
- **柔軟な入力対応**: ファイルとURIの両方に対応